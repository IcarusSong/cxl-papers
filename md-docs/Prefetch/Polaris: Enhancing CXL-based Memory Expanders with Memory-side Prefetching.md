
# Polaris: Enhancing CXL-based Memory Expanders with Memory-side Prefetching
## 作者以及出版物
### 作者

1.  **Zhe Zhou (周哲)**：北京大学集成电路学院，北京大学计算机学院。
2.  **Shuotao Xu (徐硕涛)**：微软亚洲研究院。
3.  **Yiqi Chen (陈一琦)**：北京大学集成电路学院。
4.  **Tao Zhang (张涛)**：微软亚洲研究院。
5.  **Ran Shu (舒然)**：微软亚洲研究院。
6.  **Lei Qu (屈磊)**：微软亚洲研究院。
7.  **Peng Cheng (程鹏)**：微软亚洲研究院。
8.  **Yongqiang Xiong (熊永强)**：微软亚洲研究院。
9.  **Guangyu Sun (孙广宇)**：北京大学集成电路学院，北京大学计算机学院，北京集成电路高精尖创新中心。他是本文的通讯作者（Corresponding author），通常负责论文的主要研究工作和投稿事宜。
### 出版物
APPT'23


## 1. 文章背景

随着数据中心对内存容量和带宽的需求不断增长，传统的服务器内存扩展方式（如增加更多DDR通道）遇到了瓶瓶颈。**Compute Express Link (CXL)** 协议作为一种新兴的开放标准，提供了一种高效的解决方案。它允许CPU通过高速互联总线，以缓存一致性（cache-coherent）的方式访问连接在CXL总线上的内存扩展设备（CXL内存）。
![](https://pic1.imgdb.cn/item/6880ee5558cb8da5c8d1acfd.png)
**核心问题**：尽管CXL内存比过去的PCIe或RDMA扩展方案延迟低得多，但由于控制和传输开销，其访问延迟仍然是本地DDR内存的**约2倍**。这种延迟差距会严重影响对延迟敏感型工作负载的性能，甚至导致高达50%的性能下降。如何弥合CXL内存与本地内存之间的性能差距，是充分发挥CXL优势的关键挑战。

## 2. 相关工作以及局限性

为了解决CXL内存的高延迟问题，研究者们探索了多种方法，但都存在局限性：

1.  **系统级优化（热/冷数据分层）**:
    *   **方法**: 通过操作系统（OS）或应用程序，将访问频繁的“热”数据放置在低延迟的本地内存中，将不常用的“冷”数据放置在高延迟的CXL内存中。
    *   **局限性**:
        *   **需要复杂修改**: 需要修改操作系统内核或应用程序，部署成本高。
        *   **粗粒度管理**: 通常以内存页（Page）或虚拟机（VM）为单位进行数据迁移，粒度较粗。这会引发**读/写放大**问题，并且无法充分利用CXL支持细粒度（缓存行级别）访问的优势。

2.  **CPU侧缓存预取（CPU-side Prefetching）**:
    *   **方法**: 利用CPU自身的硬件预取器来预测并提前加载CXL内存中的数据到CPU缓存中，从而隐藏访问延迟。
    *   **局限性 (论文的核心论点之一)**:
        *   **覆盖率与准确率的矛盾**: 为了隐藏CXL的长延迟，CPU预取器需要变得非常“激进”以提高预取覆盖率。然而，激进的预取通常会导致预取准确率下降。
        *   **缓存污染 (Cache Pollution)**: 不准确的预取会将无用的数据加载到CPU缓存中，挤出有用的数据，导致缓存效率下降。
        ![](https://pic1.imgdb.cn/item/6880eedf58cb8da5c8d1b24a.png)
        *   **带宽浪费 (Bandwidth Waste)**: 错误的预取会消耗宝贵的CPU到CXL设备的内存带宽。
        *   **修改成本高**: 专门为CXL优化或设计新的CPU预取器，需要对CPU进行昂贵的硬件修改，实施难度大。

论文通过对最先进的CPU预取器（如Pythia）的评估，证明了即使是强大的CPU预取器也无法有效解决CXL的延迟问题，仍然有大量任务性能受损严重。
![](https://pic1.imgdb.cn/item/6880eea258cb8da5c8d1b007.png)
![](https://pic1.imgdb.cn/item/6880eec858cb8da5c8d1b173.png)
## 3. 论文发现以及论文贡献

*   **论文发现**: 论文通过实验发现，单纯依赖CPU侧的预取机制存在一个难以调和的根本性矛盾：**在CXL场景下，为追求高预取覆盖率而采取的激进策略，会不可避免地导致严重的缓存污染和带宽浪费，从而限制了性能提升的上限**。因此，需要跳出“在CPU侧解决问题”的思维定式。
![](https://pic1.imgdb.cn/item/6880ee7458cb8da5c8d1ae32.png)
*   **论文贡献**:
    1.  **提出POLARIS框架**: 首次提出了一种在**CXL内存扩展设备侧（Memory-side）**集成硬件预取器的创新方案，名为POLARIS。这是一种近内存计算（Near-memory processing）的实践。
   ![](https://pic1.imgdb.cn/item/6880ef0f58cb8da5c8d1b3fd.png)
    2.  **设计POLARIS-Base**: 一个**非侵入式**的基础版本。它无需修改CPU或软件，可作为现有服务器的“即插即用”升级方案。它在CXL控制器中集成预取器和专用的SRAM缓存（PFB），为预取命中的请求建立“快捷方式”，显著降低延迟。
    3.  **设计POLARIS-Active**: 一个更高性能的**主动**版本。它提出只需对CPU进行微小的修改（如扩展Intel的DDIO功能），就能将高置信度的预取数据**主动推送（push）**到CPU的末级缓存（LLC）中，从而最大程度地隐藏CXL访问延迟。
    4.  **提出集成的动态预取器选择机制**: POLARIS不使用单一的预取器，而是**集成了四种不同的预取器**，并设计了一套基于分数的动态选择机制，可以在运行时为当前的工作负载选择表现最好的预取器，从而兼顾了覆盖率和准确率。
    5.  **全面的模拟和评估**: 通过详尽的模拟实验，证明了POLARIS相比多种CPU侧预取器方案，能更有效地弥合CXL内存的性能鸿沟。

## 4. 方法策略（如何利用这个发现，遇到了什么困难？设计了什么方法-策略）

**核心策略**：将预取功能从CPU侧转移到CXL内存设备侧。

**POLARIS-Base 的设计**：
*   **如何工作**:
    1.  在CXL内存控制器芯片上集成一个硬件预取器和一个专用的SRAM缓存，称为**预取缓冲区 (Prefetch Buffer, PFB)**。
    2.  当CPU的读请求到达CXL设备时，该请求地址会被送入PFB进行查询，同时也被送入预取器进行分析。
    3.  **如果请求在PFB中命中**：数据直接从高速的PFB（SRAM）返回给CPU，绕过了访问慢速DRAM的路径，形成了一条“快捷方式”，大大缩短了延迟。
    4.  **如果请求在PFB中未命中**: 请求正常转发至设备上的DRAM，并将返回的数据发送给CPU。
    5.  与此同时，设备侧的预取器会根据历史访问模式，预测CPU接下来可能需要的数据，并提前从DRAM中将这些数据加载到PFB中，为下一次“命中”做准备。
*   **遇到的困难与解决方案**:
    *   **困难**: 如何避免影响正常的内存访问路径？
    *   **方案**: 采用并行查询设计，PFB不处在访问DRAM的关键路径上。请求同时查询PFB和发往DRAM队列，如果PFB命中，则从DRAM队列中撤销该请求，节省DRAM带宽。

**Ensembled Prefetcher (集成预取器) 的设计**：
*   **遇到的困难与解决方案**:
    *   **困难**: 经过CPU多级缓存的过滤，到达CXL内存的访问模式非常不规律，单一的预取算法难以适应所有工作负载。
    *   **方案**:
        ![](https://pic1.imgdb.cn/item/6880ef3958cb8da5c8d1b5ac.png)
        1.  **集成 (Ensemble)**: 集成了四种经典的、仅依赖物理地址的预取器（BOP, Domino, SPP, VLDP）。
        2.  **动态选择 (Score-based Selector)**: 设计了一套巧妙的“虚拟预取”机制。所有预取器只“生成”预测地址，但不实际执行预取。这些预测地址被记录在各自的布隆过滤器（Bloom Filter）中。当一个真实的CPU请求到来时，系统会检查它是否在某个预取器的布隆过滤器中（即“虚拟命中”）。虚拟命中次数最多的预取器得分最高，POLARIS会采用该预取器进行**实际的**预取操作。这个机制能动态选出当前最优的预取器。

**POLARIS-Active 的设计**：
*   **遇到的困难与解决方案**:
    *   **困难1：数据一致性**。直接将数据推送到CPU的LLC，可能会覆盖掉CPU中更新的、尚未写回的“脏”数据。标准的DDIO（Direct Data I/O）机制存在此问题。
    *   **方案1**: 提出对DDIO协议进行微小扩展，增加一个**`Write-Ignore`**（写忽略）操作。当POLARIS推送的预取数据在LLC中已存在时，CPU直接忽略这次写入，从而保证了LLC中数据的新鲜度。
    ![](https://pic1.imgdb.cn/item/6880ef6258cb8da5c8d1b72b.png)
    *   **困难2：带宽和缓存资源的浪费**。主动推送会消耗CXL链路带宽和LLC缓存空间，如果推送的数据不准，得不偿失。
    *   **方案2**: **只推送高置信度的预取**。通过集成预取器的得分机制计算出当前预取器的**准确率（Accuracy）**。只有当准确率超过一个预设阈值`T`时，才触发主动推送；否则，仍然只将数据预取到设备侧的PFB中。

## 5. 实验设置与实验结果

*   **实验平台**: 论文使用的是一个**周期精确的模拟器（cycle-accurate ChampSim simulator）**。他们修改了模拟器以支持CXL通道、延迟注入、PFB以及内存侧预取器等行为。**这不是真实的CXL ASIC、NUMA模拟或FPGA平台**，这是计算机体系结构研究中常见的、用于早期设计验证的学术方法。

*   **实验效果与对比指标**:
    ![](https://pic1.imgdb.cn/item/6880ef9c58cb8da5c8d1b961.png)
    *   **核心指标**: `Slowdown`（公式3）。该指标计算了“使用CXL内存时的IPC”相对于“使用本地DDR内存时的IPC”的性能下降百分比。`Slowdown`越接近0，说明CXL延迟被隐藏得越好。
    ![](https://pic1.imgdb.cn/item/6880efc258cb8da5c8d1ba21.png)
    *   **效果**:
        *   在单核场景下，POLARIS能将原本高达-25%的平均性能下降，缓解到-1%至-10%的水平。
        *   **POLARIS平均能让43%的工作负载“有效容忍”（性能差距<5%）CXL的长延迟**，在某些配置下这一比例高达85%。
        *   在多核场景下，POLARIS-Active甚至能实现比本地内存更高的性能（IPC提升8%），因为它补偿了没有CPU侧预取器的情况。

*   **对比公平性与全面性**:
    *   **公平性**: 对比非常公平。它将POLARIS与多种基准进行了比较：1）无预取器；2）商业CPU中常用的Streamer预取器；3）开源CPU中使用的BOP预取器；4）最先进的学术研究成果Pythia预取器。在对比时，CPU侧的配置保持一致。
    *   **全面性**: 实验设计非常全面。
        *   **解决问题效果好**: 通过对比有无POLARIS的`Slowdown`（图9），证明了其有效性。
        *   **比相关工作好**: 通过与多种CPU侧预取器对比，证明了内存侧预取的优越性。
        ![](https://pic1.imgdb.cn/item/6880f05658cb8da5c8d1be61.png) 
        *   **效果合理性分析**: 通过分析预取覆盖率（图12），展示了POLARIS额外覆盖了大量CPU预取器未命中的情况，解释了性能提升的来源。
        ![](https://pic1.imgdb.cn/item/6880eff758cb8da5c8d1bae6.png)
        ![](https://pic1.imgdb.cn/item/6880f01958cb8da5c8d1bc6a.png)
        ![](https://pic1.imgdb.cn/item/6880f04358cb8da5c8d1bdd4.png)
        *   **消融实验**: 通过对比集成预取器与单个预取器的性能（图13），证明了集成与动态选择机制的优越性。还通过改变DRAM带宽（图14）和PFB大小（图15）进行了敏感性分析，验证了设计的合理性和鲁棒性。

## 6. 前提假设与局限性

*   **前提假设**:
    1.  **微小的CPU修改可行性**: POLARIS-Active的实现依赖于CPU厂商愿意对其DDIO逻辑进行微小修改（增加`Write-Ignore`功能）。这是一个重要但并非不切实际的假设。
    2.  **设备侧资源预算**: 假设CXL内存扩展卡的制造商有足够的芯片面积（约27.1 mm²）和功耗预算（约1.77 W）来集成预取器逻辑和PFB缓存。
    3.  **设备侧带宽有富余**: 设计利用了设备侧DRAM带宽高于CXL链路带宽这一特点。这在当前标准下成立，但未来可能改变。

*   **局限性**:
    1. **CPU侧与设备侧协同问题**：论文中，CPU侧的预取请求也会被设备侧当成普通的内存请求，没有和设备测的预取器进行很好的协同。
    ![](https://pic1.imgdb.cn/item/6880f09558cb8da5c8d1bff7.png)
    2.  **多核扩展性问题**: 论文指出，在8核等高负载场景下，POLARIS-Active与某些CPU预取器（如BOP）结合使用时性能会下降，原因是DDIO资源和CXL带宽竞争激烈。作者承认，针对多核场景优化参数是未来工作。
    3.  **对写操作的关注较少**: 论文主要关注由读请求引发的延迟问题，对写密集型工作负载的影响分析不够深入。

## 7. 改进方向
1. 增加Host侧（CPU/OS）与设备侧的协同，比如OS读取设备测的数据，进行更加智能的预取。