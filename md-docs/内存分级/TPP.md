# TPP

内存拓展成本-》DRAM内存技术通过构建分层内存子系统和以更低的成本/GB点添加更高的内存容量-》从延迟和带宽来看CXL是个好选择-》内存分层是是否有益呢？-》需要了解数据中心应用的行为-》观察不同应用特点-》四个观察-》设计TPP-》TPP机制-》TPP实现-》TPP效果-》未来展望

## 内存分层出现背景
在数据中心中，应用对内存的需求激增，由于增加DRAM带来的高额成本以及拓展内存带来的技术挑战，使得内存成为超大规模数据中心基础设置支出的重要部分，微软表示，50%的服务器总成本来自DRAM。
![](https://pic1.imgdb.cn/item/67f7bd2688c538a9b5c8dd76.png)
可以利用程序局部性，进行存储分层，利用高速存储的延迟和低俗内存的容量，降低数据中心的内存成本。

在CXL之前的内存分层技术（PCIe、RDMA），相较于主存而言，都有更高的延迟，在数据在不同层级的内存层次结构中分配不当时，会造成严重的性能损失。

CXL的出现解决了这一问题，既解决了非DRAM内存的高延迟问题，又保留了类似 DRAM 的高带宽和细粒度访问能力。
![](https://pic1.imgdb.cn/item/67f7bb8188c538a9b5c8da2a.png)
![](https://pic1.imgdb.cn/item/67f7bb9588c538a9b5c8da69.png)

## 内存分层带来的影响
为了测试内存分层是否有意，需要了解数据中心中各类应用的内存访问行为。对于每个应用，需要了解其内存中有多少在特定时间段内保持**热、温或冷**，以及有多少内存是短期的，或者是长期的。

现有的基于空闲页面跟踪（IPT）的工具无法满足需求，原因包括以下几点：

1. **内核修改限制**：这些工具需要对内核进行修改，这在生产环境中通常是不可行的。
2. **高资源开销**：持续的访问位采样和分析会导致过高的CPU和内存开销，难以扩展到大工作集。
3. **缺乏页类型敏感性**：应用程序对不同类型内存页（如匿名页、文件页缓存、共享内存等）的敏感性不同，而现有工具未能考虑这一点。

## 数据中心应用的特征分析

作者通过开发 **Chameleon** 工具对数据中心应用的内存使用行为进行了详细分析。Chameleon 是一种轻量级的用户空间工具，能够高效地表征应用程序的内存访问模式，而无需修改内核或干扰生产环境中的运行应用。
![](https://pic1.imgdb.cn/item/67f7c71a88c538a9b5c8ef94.png)


### 工作负载概述
- **目标**：
  - 使用 Chameleon 分析 Meta 生产服务器集群中运行的多种大型内存密集型应用。
  - 这些工作负载涵盖四个不同的服务域（Web、缓存、数据仓库、广告服务），代表了数据中心中广泛的应用场景。

- **典型应用**：
  - **Web**：基于虚拟机（如 HHVM 或 Python）处理 Web 请求。
  - **缓存（Cache）**：分布式内存对象缓存服务，用于低延迟数据检索。
  - **数据仓库（Data Warehouse）**：支持并行数据处理的统一计算引擎。
  - **广告服务（Ads）**：计算密集型工作负载，结合内存数据和机器学习计算。


### 3.2 页面热度分布
- **主要观察**：
  - 数据中心应用中，大量分配的内存页面在其生命周期内保持“冷”状态（即不频繁访问）。
  - 在两分钟的时间窗口内，Web、缓存和广告应用中仅有 **22%-80%** 的内存被频繁访问。
  - 数据仓库应用中，即使其工作集可能达到 TB 级别，也只有 **20%** 的内存是热的。

- **推论**：
  - 存在大量冷内存页面，可以迁移到较慢的内存层（如 CXL 内存），而不会显著影响性能。
  - 分层内存系统适合这种工作负载特性。


### 3.3 不同页面类型的热度差异
- **匿名页 vs 文件页**：
  - 匿名页（anon pages）通常比文件页（file pages）更热。
  - 在 Web 应用中，35%-60% 的匿名页是热的，而只有 3%-14% 的文件页是热的。
  - 缓存应用中，匿名页主要用于查询处理，文件页则用于快速查找。尽管如此，匿名页的热度仍然高于文件页。

- **推论**：
  - 匿名页更适合放置在快速本地内存中，而文件页可以优先分配到较慢的内存层。


### 3.4 不同页面类型随时间的变化
- **动态变化**：
  - Web 应用启动时加载二进制文件和字节码，导致文件缓存占用大量内存；随着时间推移，匿名页逐渐增长，文件缓存被丢弃。
  - 缓存应用主要依赖文件缓存进行内存查找，文件页占总内存的比例稳定在 70%-82%。
  - 数据仓库应用中，匿名页占总内存的 85%，文件页仅占 15%。

- **推论**：
  - 应用程序的内存使用模式虽然可能随时间变化，但总体上保持相对稳定。
  - 智能页面放置机制应考虑页面类型以优化性能。


### 3.5 页面类型对性能的影响
- **敏感性分析**：
  - 不同应用对匿名页和文件页的敏感性不同。
  - Web 应用的吞吐量随着匿名页利用率的提高而增加。
  - 缓存应用中，tmpfs 和固定数量的匿名页对性能影响较小。
  - 数据仓库应用中，匿名页的使用量与吞吐量高度相关。

- **推论**：
  - 应用对不同页面类型的敏感性因工作负载而异，智能内存管理机制需要根据这些特性进行优化。


### 3.6 冷页面的再访问时间
- **主要观察**：
  - 冷页面往往在一段时间后被重新访问。
  - Web 和缓存应用中，约 **80%** 的冷页面在 10 分钟内被重新访问。
  - 数据仓库应用中，匿名页通常是新分配的，只有 **20%** 的热文件页被重复访问。

- **推论**：
  - 冷页面的再访问时间因工作负载而异。
  - 分层内存系统需要主动将热页面迁移到快速内存节点，以避免高访问延迟。

---

### **总结**
通过对数据中心应用的详细分析，作者得出了以下关键结论：
1. **冷页面占比高**：数据中心应用中存在大量冷页面，可以迁移到较慢的内存层以释放快速内存资源。
2. **匿名页更热**：匿名页通常比文件页更热，且对性能更敏感。
3. **稳定的内存使用模式**：尽管内存使用可能随时间变化，但大多数应用的页面使用模式相对稳定。
4. **冷页面再访问时间的影响**：冷页面的再访问时间因工作负载而异，分层内存系统需要动态调整页面放置策略。

这些观察结果为设计高效的分层内存管理系统（如 TPP）提供了重要依据，能够在不影响性能的情况下优化内存资源的使用。