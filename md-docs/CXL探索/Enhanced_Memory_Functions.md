
# Enhanced_Memory_Functions

## 作者以及出版物
### 作者
- David Boles , Micron Technology, Austin, TX, 78730, USA  
- Daniel Waddington , IBM, San Jose, CA, 95120, USA 
- David A. Roberts , Micron Technology, Boise, ID, 83707, USA

### 出版物
2023 IEEE Micro

## 背景
CXL是一个开放标准的异步协议，它建立在PCIe物理层之上，允许第三方供应商创造能与CPU共享内存直接交互的设备 。它允许在内存数据平面上进行技术插入，这为将某些功能下推(卸载)到内存子系统创造了可能性。

## 方法
本文提出了EMFs（Enhanced Memory Functionals）的概念。本文的核心是利用CXL协议将传统上由cpu或os执行的功能下推（卸载）到内存控制器中执行。而所谓的EMFs，正是这些被下推的功能。通过在更靠近内存介质的地方执行这些功能，可以实现更高的带宽、更低的延迟和更低的能耗。

论文中提到，一个有效的EMFs拥有以下一个或多个特性：
- 靠近内存介质：能够以低延迟和低能耗访问内存
- 数据平面插入能力：可以直接干预内存的read/write
- 独立于cpu的cache层次：能够观察到主内存的真实状态，不受到缓存的影响
- 独立于ISA：避免受到微架构复杂性（例如内存屏障、推测执行）的影响
- 与虚拟内存子系统分离：能够提高实现效率，并将监控粒度与操作系统的页面大小解耦 
- 与主机处理器交互能力：能够与主机协调以维护数据一致性

论文中列举了一个表格，提供了六类设想的EMFs


| **类别**           | **增值功能**                                                                 |
|--------------------|----------------------------------------------------------------------------|
| **I. 事务处理**    | a) 在非易失性内存（NVM）上实现透明的崩溃一致性事务（如回滚）。<br>b) 在易失性内存上实现事务，用于分布式系统中的共享内存一致性。 |
| **II. 日志与追踪**  | a) 软件调试、性能分析和执行回放。<br>b) 内存快照（如虚拟机实时迁移）。 |
| **III. 数据移动**   | a) 访问分析（如内存访问热力图）。<br>b) 性能计数器（如访问计数、访问延迟、平均带宽）。<br>c) 缓存与内存分层：按需将数据行移动到更快或更慢的内存（如本地与远程内存之间）。<br>d) 网络/结构桥接（如CXL到RDMA）。<br>e) 预取：利用访问模式提前获取缓存行。<br>f) 地址转换——为重新映射和共享添加额外的内存转换层。 |
| **IV. 安全**       | a) 静态内存加密/解密。<br>b) 安全飞地；限制对内存区域的访问（时间或空间上）。<br>c) 持续数据保护；使用写时复制日志记录创建内存写入历史。<br>d) 内存取证；“嗅探”内存事务以进行网络安全和审计（如识别未授权数据访问）。<br>e) 恶意软件检测（如行锤攻击）与防护。 |
| **V. 可靠性、可用性、可维护性（RAS）** | a) 内存复制以实现容错（如跨DIMM、跨节点）。<br>b) 跨本地或远程内存的纠删编码。<br>c) 零拷贝重新挂接以实现高可用性。<br>d) 详细的硬件故障可见性。<br>e) 为低可靠性、低成本内存提供额外的ECC编码。 |
| **VI. 数据效率**    | a) 压缩；异步压缩并将内存区域分页到其他内存或存储区域。<br>b) 去重；共享内容相同的内存区域（如跨虚拟机的内核代码页）。<br>c) 内存填充；向内存写入零或特定字节模式（如单位矩阵）。<br>d) 领域特定操作（如矩阵乘法）。 |  


## 例子
本文针对提出的EMFs提出了两个例子，一个是内存访问热图（Access Heat Maps），即将内存访问分析卸载到CXL控制器上，这在**NeoMem**中已经实现；另一个是内存回滚 (Memory Roll-back)来实现崩溃一致性

### 内存回滚
**问题**：在持久性内存（Persistent Memory）编程中，实现崩溃后数据一致性是一个关键挑战。传统的纯软件方法（如英特尔的PMDK）需要修改应用程序代码，使用特定的数据结构，并且会带来巨大的性能开销和写放大问题。

**EMF解决方案**：论文提出了一种内存回滚功能，通过硬件来保证事务的原子性 。该功能利用“微堆”（microheaps）来管理与特定数据结构关联的内存 。在事务开始时，控制器会自动保存相关内存区域的快照。事务期间的写操作，硬件会自动记录修改前的旧数据（undo log） 。事务结束后，可以提交修改或中止事务并恢复到初始状态。

**验证**：研究人员在一个基于FPGA的CXL内存设备上实现了此功能。与使用PMDK的软件方案相比，内存回滚EMF在执行红黑树操作时，写入内存介质的缓存行数量显著减少，写放大因子从3.5倍-4.1倍降低。这证明了该方法不仅效率更高，而且能够让现有软件库更容易地支持持久性内存。

对于崩溃一致性，已有CXL方面的学术研究，暂时留坑，之后补上。